<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinh tử môn</title>

    <link rel="stylesheet" href="/css/style.css">
    <!-- <script src="https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.min.js"></script>

</head>

<body>

    <script>
        var towers = []
        var tower1; //test
        var temp;
        var bullets = []

        var isBuying = false;

        var range = 30
        var COLLISION = [
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];



        var OFFSET_Y = 100;
        var OFFSET_RIGHT_X = 180;
        var OFFSET_DOWN_Y = 30;
        var GAME_WIDTH = 520;
        var GAME_HEIGHT = 520;
        var CELL_SIZE = 40;
        var START_POS = {
            x: 0,
            y: 0
        };

        var monsters = [];
        var square = null;

        var gold = null;
        var tower = null;

        var goldText = null;
        var config = {
            type: Phaser.AUTO,
            width: 700,
            height: 650,
            physics: {
                default: 'arcade',
                // arcade: {
                //     gravity: { y: 200 }
                // }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('square', '/img/square1.png');
            this.load.image('bigBee', '/img/bigBee.png');
            this.load.image('frozen', '/img/frozen.png');
            this.load.image('arrow', '/img/arrow.png');
            this.load.image('bullet', '/img/bullet.png');

            wave = {
                id: 1,
                quantity: 1
            };

            life = 10;
            gold = 250;

        }

        function create() {
            // ô vuông
            for (let i = 0; i < GAME_HEIGHT / CELL_SIZE; i++) {
                for (let j = 0; j < GAME_WIDTH / CELL_SIZE; j++) {
                    if (!COLLISION[i][j]) {
                        let square =
                            this.add.image(
                                j * CELL_SIZE + 20,
                                i * CELL_SIZE + OFFSET_Y,
                                "square"
                            ).setDisplaySize(40, 45);

                        //Buying
                        square.setInteractive()
                        square.on("pointerdown", (pointer) => {
                            console.log("clicked square")
                            if (isBuying) {
                                let tower = this.add.image(square.x, square.y, "arrow");
                                tower.setDisplaySize(40, 40)
                                tower.setDepth(-1)
                                tower.isReady = true;
                                towers.push(tower)
                            }
                        })

                    }
                }

            }
            this.add.text(1, 60, 'Cửa vào', { fontSize: '15px', fill: '#aaa' });
            this.add.text(445, 605, 'Cửa ra', { fontSize: '20px', fill: '#aaa' });
            this.add.text(300, 50, `Đợt ${wave.id}`, { fontSize: '20px', fill: '#aaa' });

            goldText = this.add.text(560, 180, `Vàng: ${gold}`, { fontSize: '20px', fill: '#aaa' });


            // tháp mẫu
            this.add.text(560, 200, 'Tháp', { fontSize: '20px', fill: '#aaa' });
            this.add.text(560, 420, 'Skill', { fontSize: '20px', fill: '#aaa' });


            tower1 = this.add.image(580, 250, "arrow").setDisplaySize(40, 40);
            tower1.setInteractive();
            this.add.image(580, 300, "arrow").setDisplaySize(40, 40);
            this.add.image(580, 350, "arrow").setDisplaySize(40, 40);
            this.add.image(640, 250, "frozen").setDisplaySize(40, 40);
            this.add.image(640, 300, "frozen").setDisplaySize(40, 40);
            this.add.image(640, 350, "frozen").setDisplaySize(40, 40);

            tower1.on("pointerdown", (pointer) => {
                //tạo tháp từ con trỏ chuột
                //if gold >= tower.price

                if (isBuying) {
                    temp.destroy();
                }

                isBuying = true;
                temp = this.physics.add.image(pointer.x, pointer.y, "arrow");
                temp.setDisplaySize(40, 40)
                temp.setAlpha(0.5)

            })

            //Wave
            // let monsterRespawnEvent = this.time.addEvent({ delay: 10000, callback: () => monsterRespawn.call(this, 15), callbackScope: this, loop: true });
            monsterRespawn.call(this, 15)
        }

        function monsterRespawn(number) {
            for (let i = 0; i < 15; i++) {
                this.time.addEvent({
                    delay: i * 650, callback: () => {
                        let monster = this.physics.add.image(20, OFFSET_Y, "bigBee");
                        monster.setDisplaySize(40, 40);
                        monster.setVelocity(80, 80)
                        monster.setDepth(0)
                        monsters.push(monster)
                    }, callbackScope: this, loop: false
                });
            }

        }

        function shoot(monsters, towers) {
            //shoot
            towers.forEach(tower => {
                let count = 0;
                monsters.forEach(monster => {
                    if (monster.x > tower.x - range && monster.x < tower.x + range
                        && monster.y > tower.y - range && monster.y < tower.y + range
                        && tower.isReady //sẵn sàng bắn // chờ nạp đạn
                    ) {
                        count++;
                    }

                })
                if (count > 0) {


                    //nạp đạn
                    tower.setTint("0xff00")
                    tower.isReady = false;
                    this.time.addEvent({
                        delay: 2000, callback: () => {
                            tower.clearTint()
                            tower.isReady = true;
                        }, callbackScope: this, loop: false
                    });

                    //Tạo đạn và bắn

                    let bullet = this.physics.add.image(tower.x, tower.y, 'bullet');
                    bullet.setTint("0xffffff")
                    bullet.setDisplaySize(30, 30);
                    bullet.speed = 200
                    bullet.setDepth(1)
                    bullets.push(bullet)

                }

                else {
                    tower.setDisplaySize(40, 40)
                }
            })
        }
        function moveTo(source, target, speed) {
            //angel
            let angle = Math.atan2(Math.abs(target.x - source.x), Math.abs(target.y - source.y));

            if (target.x > source.x) {
                source.setVelocityX(speed * Math.sin(angle))
            }
            else {
                source.setVelocityX(-1 * speed * Math.sin(angle))
            }

            if (target.y > source.y) {
                source.setVelocityY(speed * Math.cos(angle))
            }
            else {
                source.setVelocityY(-1 * speed * Math.cos(angle))
            }

        }
        function update() {
            //end game
            if (life < 1) {
                return
            }

            //is buying
            if (isBuying) {
                this.input.on("pointermove", (pointer) => {
                    temp.x = pointer.x
                    temp.y = pointer.y
                })
            }

            // Huỷ chọn mua tháp khi click ra ngoài
            this.input.on("pointerdown", (pointer) => {
                if (isBuying
                    && pointer.y > GAME_HEIGHT + OFFSET_Y
                    // && pointer.y > OFFSET_Y + GAME_HEIGHT
                ) {
                    console.log("clicked everywhere")
                    isBuying = false;
                    temp.destroy();
                }
            })


            //Cập nhật đường đạn
            bullets.forEach(bullet => {
                moveTo.call(this, bullet, monsters[0], bullet.speed);
            })

            //fire
            shoot.call(this, monsters, towers)

        }
    </script>
</body>

</html>