<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="/css/style.css">
    <!-- <script src="https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.min.js"></script>

</head>

<body>

    <script>
        var fire = null
        var range = 40
        var COLLISION = [
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];

        var OFFSET_Y = 100;
        var OFFSET_RIGHT_X = 180;
        var OFFSET_RIGHT_Y = 30;
        var GAME_WIDTH = 520;
        var GAME_HEIGHT = 520;
        var CELL_SIZE = 40;
        var START_POS = {
            x: 0,
            y: 0
        };

        var monsters = [];
        var square = null;

        var gold = null;
        var tower = null;

        var goldText = null;
        var config = {
            type: Phaser.AUTO,
            width: 700,
            height: 650,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 200 }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('square', '/img/square1.png');
            this.load.image('bigBee', '/img/bigBee.png');
            this.load.image('frozen', '/img/frozen.png');
            this.load.image('arrow', '/img/arrow.png');

            wave = {
                id: 1,
                quantity: 1
            };

            life = 10;
            gold = 250;
        }

        function create() {
            // ô vuông
            for (let i = 0; i < GAME_HEIGHT / CELL_SIZE; i++) {
                for (let j = 0; j < GAME_WIDTH / CELL_SIZE; j++) {
                    if (!COLLISION[i][j]) {
                        let square = this.add.image(
                            j * CELL_SIZE + 20,
                            i * CELL_SIZE + OFFSET_Y,
                            "square"
                        ).setDisplaySize(40, 45);
                    }
                }

            }
            this.add.text(1, 60, 'Cửa vào', { fontSize: '15px', fill: '#aaa' });
            this.add.text(445, 605, 'Cửa ra', { fontSize: '20px', fill: '#aaa' });
            this.add.text(300, 50, `Đợt ${wave.id}`, { fontSize: '20px', fill: '#aaa' });

            goldText = this.add.text(560, 180, `Vàng: ${gold}`, { fontSize: '20px', fill: '#aaa' });
            // tháp mẫu
            this.add.text(560, 200, 'Tháp', { fontSize: '20px', fill: '#aaa' });
            this.add.text(560, 420, 'Skill', { fontSize: '20px', fill: '#aaa' });
            let tower1 = this.add.image(580, 250, "arrow").setDisplaySize(40, 40);
            tower1.setInteractive();
            tower1.on("wheel", function (pointer, deltaX, deltaY, deltaZ) {
                //drag drop tower
                console.log("ok")
            })

            //Tháp đã xây
            fire = this.add.image(CELL_SIZE * 8 + 20, OFFSET_Y + CELL_SIZE * 8, "arrow").setDisplaySize(40, 40);

            tower1.on("over", function (pointer, deltaX, deltaY, deltaZ) {
                //show tower info

            })
            this.add.image(580, 250, "arrow").setDisplaySize(40, 40);
            this.add.image(580, 300, "arrow").setDisplaySize(40, 40);
            this.add.image(580, 350, "arrow").setDisplaySize(40, 40);
            this.add.image(640, 250, "frozen").setDisplaySize(40, 40);
            this.add.image(640, 300, "frozen").setDisplaySize(40, 40);
            this.add.image(640, 350, "frozen").setDisplaySize(40, 40);

            //Wave
            // let monsterRespawnEvent = this.time.addEvent({ delay: 10000, callback: () => monsterRespawn.call(this, 15), callbackScope: this, loop: true });
            monsterRespawn.call(this, 15)
        }

        function monsterRespawn(number) {
            for (let i = 0; i < number; i++) {
                this.time.addEvent({
                    delay: i * 650, callback: () => {
                        let monster = this.physics.add.image(20, OFFSET_Y, "bigBee");
                        monster.setDisplaySize(40, 40);
                        monster.speed = 300;
                        monsters.push(monster)
                    }, callbackScope: this, loop: false
                });
            }
        }

        function update() {
            //end game
            if (life < 1) {
                return
            }


            //monster move
            let count = 0;
            monsters.forEach(element => {
                element.setVelocity(element.speed, element.speed)

                //fire

                if (element.x > fire.x - 20 && element.x < fire.x + 20
                    && element.y > fire.y - 20 && element.y < fire.y + 20

                ) {
                    count++;
                 
                }
                else {
                    count--;
                   
                }
                if(count + monsters.length > 0) {
                    fire.setDisplaySize(45,45)
                }
                else {
                    fire.setDisplaySize(40,40)
                }
            });



        }
    </script>
</body>

</html>